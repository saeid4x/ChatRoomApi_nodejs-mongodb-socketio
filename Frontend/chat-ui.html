<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat API Tester</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; max-width: 800px; margin: auto; }
        .controls, .chat-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        input { width: 95%; padding: 8px; margin-bottom: 10px; }
        button { padding: 8px 12px; cursor: pointer; }
        #messages { list-style-type: none; padding: 0; height: 300px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; }
        #messages li { padding: 5px; border-bottom: 1px solid #f0f0f0; }
        #messages li:nth-child(odd) { background-color: #f9f9f9; }
        small { color: #888; }
    </style>
</head>
<body>
    <h1>Chat API WebSocket Tester</h1>

    <div class="controls">
        <h3>1. Connect</h3>
        <input type="text" id="token" placeholder="Paste Access Token (JWT) here">
        <button id="connectBtn">Connect to Socket Server</button>
        <p id="status" style="color: red;">Status: Disconnected</p>
    </div>

    <div class="controls">
        <h3>2. Join Room</h3>
        <input type="text" id="roomId" placeholder="Paste Room ID here">
        <button id="joinBtn" disabled>Join Room</button>
    </div>

    <div class="chat-box">
        <h3>3. Send Messages</h3>
        <ul id="messages"></ul>
        <input type="text" id="message" placeholder="Enter message" disabled>
        <button id="sendBtn" disabled>Send</button>
        <br>
        <div class="upload-area">
            <label for="image-upload">Upload Image:</label>
            <input type="file" id="image-upload" accept="image/*">
            <button id="uploadBtn" disabled>Upload & Send</button>
        </div>
    </div>


    <!-- ADD THIS ENTIRE DIV BLOCK -->
    <div class="side-panel">
        <h3>Online Users</h3>
        <ul id="online-users"></ul>
    </div>
    <!-- END OF NEW BLOCK -->

      <!-- THIS IS THE CORRECTED LINE -->
            <div id="typing-indicator"></div>
            <!-- END OF CORRECTION -->

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
    // --- Element Selectors ---
    const connectBtn = document.getElementById('connectBtn');
    const joinBtn = document.getElementById('joinBtn');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('message');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const onlineUsersEl = document.getElementById('online-users');
    const typingIndicatorEl = document.getElementById('typing-indicator');
     const imageUploadInput = document.getElementById('image-upload');

    let socket;
    let typingTimeout;
    const onlineUsers = new Map();
    const typingUsers = new Map();

    // --- Main Event Handlers ---
    connectBtn.onclick = () => {
        if (socket) socket.disconnect();
        const token = document.getElementById('token').value;
        if (!token) return alert('Please provide an access token.');
        socket = io("http://localhost:3001", { auth: { token } });
        setupSocketListeners();
    };

    joinBtn.onclick = () => {
        const roomId = document.getElementById('roomId').value;
        if (!roomId) return alert('Please provide a Room ID.');

        socket.emit('joinRoom', { roomId });

        // Enable all action buttons now that we are in a room
        sendBtn.disabled = false;
        messageInput.disabled = false;
        uploadBtn.disabled = false; // <-- This is the key fix

        messagesEl.innerHTML = `<li><em>Joined room: ${roomId}</em></li>`;
        onlineUsers.clear();
        updateOnlineUsersUI();
    };

    sendBtn.onclick = () => {
        const content = messageInput.value;
        const roomId = document.getElementById('roomId').value;
        if (content && roomId) {
            socket.emit('chatMessage', { roomId, content });
            messageInput.value = '';
            // Also emit stop typing event after sending a message
            clearTimeout(typingTimeout);
            socket.emit('stopTyping', { roomId });
        }
    };
    
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendBtn.click();
            return;
        }
        // --- Emit Start Typing Event ---
        const roomId = document.getElementById('roomId').value;
        if (socket && roomId) {
             // --- DEBUG LOG 1 ---
            console.log("CLIENT: Emitting 'startTyping' event to server.");

            socket.emit('startTyping', { roomId });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('stopTyping', { roomId });
            }, 2000); // Stop typing if no keypress for 2 seconds
        }
    });

    // upload image 
     // --- THIS FUNCTION IS ALSO CORRECTED ---
    uploadBtn.onclick = async () => {
        const file = imageUploadInput.files[0];
        const roomId = document.getElementById('roomId').value;

        if (!file || !roomId) {
            return alert("Please select a file and ensure you've joined a room.");
        }
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Uploading...";

        try {
            const formData = new FormData();
            formData.append("image", file);

            const uploadResponse = await fetch('http://localhost:3001/api/uploads/image', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${document.getElementById('token').value}`
                },
                body: formData,
            }).then(res => {
                if (!res.ok) throw new Error('Upload failed with status: ' + res.status);
                return res.json();
            });

            if (uploadResponse.filePath) {
                socket.emit('chatMessage', {
                    roomId,
                    content: uploadResponse.filePath,
                    type: 'image'
                });
            } else {
                throw new Error("Server did not return a file path.");
            }

        } catch (error) {
            console.error("Upload process failed:", error);
            alert("Upload failed. Please try again.");
        } finally {
            uploadBtn.disabled = false; // Re-enable the button after completion
            uploadBtn.textContent = "Upload & Send";
            imageUploadInput.value = '';
        }
    };
    // -----



    // --- Socket Logic: Setup all listeners in one place ---
    function setupSocketListeners() {
        socket.on('connect', () => {
            statusEl.textContent = 'Status: Connected!';
            statusEl.style.color = 'green';
            joinBtn.disabled = false;
        });

        socket.on('messageUpdated' , (updatedMessage) =>{
            const messageElement = document.getElementById(updatedMessage._id);
            if(messageElement){
                // just updated the content part of message
                const contentEl = messageElement.querySelector('.content');
                contentEl.textContent = updatedMessage.content;
                const editedEl = messageElement.querySelector('.edited-tag');
                if(editedEl) editedEl.style.display = 'inline';
            }
        })

        socket.on('messageDeleted' , ({messageId}) =>{
            const messageElement = document.getElementById(messageId);
            if(messageElement){
                messageElement.remove();
            }
        })

        socket.on('disconnect', () => {
            statusEl.textContent = 'Status: Disconnected';
            statusEl.style.color = 'red';
            joinBtn.disabled = true;
            sendBtn.disabled = true;
            messageInput.disabled = true;
            onlineUsers.clear();
            typingUsers.clear();
            updateOnlineUsersUI();
            updateTypingUI();
        });

        socket.on('connect_error', (err) => alert("Connection Failed: " + err.message));
        socket.on('error', (error) => alert("Server Error: " + error.message));
        
        socket.on('messageHistory', (history) => {
            messagesEl.innerHTML = '';
            history.forEach(msg => displayMessage(msg));
        });

          // --- THIS IS THE NEW LISTENER ---
        socket.on('session', (data) => {
            localUserId = data.userId;
            console.log(`CLIENT: Session started. My user ID is ${localUserId}`);
        });

        socket.on('newMessage', (message) => {
            displayMessage(message);
        });

        // --- Listen for new Presence & Typing events ---
        socket.on('userJoined', (user) => {
            onlineUsers.set(user.id, user.username);
            updateOnlineUsersUI();
        });

        socket.on('userLeft', (user) => {
            onlineUsers.delete(user.id);
            typingUsers.delete(user.id); // Also remove from typing list
            updateOnlineUsersUI();
            updateTypingUI();
        });

        socket.on('userTyping', (user) => {
             // --- DEBUG LOG 2 ---
            console.log("CLIENT: Received 'userTyping' event for user:", user.username);
            // --------------------
              if (user.id === localUserId) return;
            typingUsers.set(user.id, user.username);
            updateTypingUI();
        });

        socket.on('userStoppedTyping', (user) => {

             // --- DEBUG LOG 3 ---
            console.log("CLIENT: Received 'userStoppedTyping' event for user:", user.username);
            // --------------------
              if (user.id === localUserId) return;

            typingUsers.delete(user.id);
            updateTypingUI();
        });
    }

    // --- UI Update Functions ---
    function updateOnlineUsersUI() {
        onlineUsersEl.innerHTML = '';
        for (const username of onlineUsers.values()) {
            const li = document.createElement('li');
            li.textContent = username;
            onlineUsersEl.appendChild(li);
        }
    }

    function displayMessage(msg) {
    const item = document.createElement('li');
    item.id = msg._id; // Assign the message ID to the list item

    
    // --- THIS IS THE DEBUGGING STEP ---
    // Log the values we are about to compare.
    console.log("Comparing IDs for message display:");
    console.log("My localUserId is:", localUserId, `(Type: ${typeof localUserId})`);
    console.log("The message sender's ID is:", msg.sender._id, `(Type: ${typeof msg.sender._id})`);
    // ------------------------------------

    const time = new Date(msg.createdAt).toLocaleTimeString();
    
    // Check if the message belongs to the current logged-in user to show buttons
    const isMyMessage = msg.sender._id === localUserId;
    const buttons = isMyMessage ? `
        <button class="edit-btn" onclick="editMessage('${msg._id}')">Edit</button>
        <button class="delete-btn" onclick="deleteMessage('${msg._id}')">Delete</button>
    ` : '';
    
    const editedTag = msg.edited ? `<small class="edited-tag">(edited)</small>` : `<small class="edited-tag" style="display:none;">(edited)</small>`;

    item.innerHTML = `
        <b>${msg.sender.username}</b>: 
        <span class="content">${msg.content}</span> 
        <small>${time}</small> 
        ${editedTag}
        ${buttons}
    `;
    messagesEl.appendChild(item);
    messagesEl.scrollTop = messagesEl.scrollHeight;
}
  // --- ADD new functions to handle button clicks ---
function editMessage(messageId) {
    const newContent = prompt("Enter the new message content:");
    if (newContent && newContent.trim() !== '') {
        socket.emit('editMessage', { messageId, newContent });
    }
}

function deleteMessage(messageId) {
    if (confirm("Are you sure you want to delete this message?")) {
        socket.emit('deleteMessage', { messageId });
    }
}
</script>
</body>
</html>